name: Package Lobechat

on:
  schedule:
  - cron: "0 2 * * 1-5"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.7
      with:
        # Repository name with owner. For example, actions/checkout
        repository: lobehub/lobe-chat
        # The branch, tag or SHA to checkout. When checking out the repository that triggered a workflow, this defaults to the reference or SHA for that event.  Otherwise, uses the default branch.
        ref: main
    - name: Get Latest Tag
      id: get-latest-tag
      run: echo "::set-output version=`git describe --tags `git rev-list --tags --max-count=1`"
      working-directory: lobe-chat
    - name: Checkout Tag
      run: git checkout tags/${{ steps.get-latest-tag.outputs.version }}
      working-directory: lobe-chat
    # - name: Make envfile
    #   uses: SpicyPizza/create-envfile@v2.0
    #   with:
    #     envkey_NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
    #     envkey_CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
    #     some_other_variable: foobar
    #     directory: lobe-chat
    #     file_name: .env
    #     fail_on_empty: false
    #     sort_keys: false
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and push
      uses: docker/build-push-action@v6
      with:
          push: true
          file: lobe-chat/Dockerfile
          secret-envs: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}, CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/lobechat:latest, ${{ secrets.DOCKERHUB_USERNAME }}/lobechat:${{ steps.get-latest-tag.outputs.version }}
    
    
              
